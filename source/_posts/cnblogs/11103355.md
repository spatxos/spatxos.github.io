---
title: NHiberante从.net framework转移到.net standard(.net core 2.2)时遇到的坑及填坑
date: 2019-06-28T16:19:00
author: 不辍
tags: []
---
<p><span style="color: #ff0000;"><span style="color: #000000;">在.net&nbsp;framework中的创建session代码先贴一个</span></span></p>
<p>&nbsp;</p>
<div class="cnblogs_code">
<pre><span style="color: #008080;"> 1</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> SessionBuilder
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">    {
</span><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> ISessionFactory _sessionFactory = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 4</span> 
<span style="color: #008080;"> 5</span>         <span style="color: #0000ff;">public</span><span style="color: #000000;"> SessionBuilder()
</span><span style="color: #008080;"> 6</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 7</span>             <span style="color: #0000ff;">if</span> (_sessionFactory == <span style="color: #0000ff;">null</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">            {
</span><span style="color: #008080;"> 9</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">创建ISessionFactory</span>
<span style="color: #008080;">10</span>                 _sessionFactory =<span style="color: #000000;"> GetSessionFactory();
</span><span style="color: #008080;">11</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">12</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">13</span> 
<span style="color: #008080;">14</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">15</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 创建ISessionFactory
</span><span style="color: #008080;">16</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">17</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: #008080;">18</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> ISessionFactory GetSessionFactory()
</span><span style="color: #008080;">19</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">20</span> <span style="color: #000000;">            //HibernatingRhinos.Profiler.Appender.NHibernate.NHibernateProfiler.Initialize();
</span><span style="color: #008080;">21</span> 
<span style="color: #008080;">22</span>             <span style="color: #0000ff;">var</span> mappers = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ModelMapper();
</span><span style="color: #008080;">23</span> <span style="color: #000000;">            mappers.AddMappings(Assembly.GetExecutingAssembly().GetExportedTypes());
</span><span style="color: #008080;">24</span> 
<span style="color: #008080;">25</span>             <span style="color: #0000ff;">var</span> cfg = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Configuration().Configure();
</span><span style="color: #008080;">26</span>             cfg.AddDeserializedMapping(mappers.CompileMappingForAllExplicitlyAddedEntities(), <span style="color: #800000;">""</span><span style="color: #000000;">);
</span><span style="color: #008080;">27</span> 
<span style="color: #008080;">28</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> cfg.BuildSessionFactory();
</span><span style="color: #008080;">29</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">30</span> 
<span style="color: #008080;">31</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">32</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 打开ISession
</span><span style="color: #008080;">33</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">34</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: #008080;">35</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> ISession GetSession()
</span><span style="color: #008080;">36</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">37</span>             <span style="color: #0000ff;">if</span> (_sessionFactory == <span style="color: #0000ff;">null</span> ||<span style="color: #000000;"> _sessionFactory.IsClosed)
</span><span style="color: #008080;">38</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">39</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">创建ISessionFactory</span>
<span style="color: #008080;">40</span>                 _sessionFactory =<span style="color: #000000;"> GetSessionFactory();
</span><span style="color: #008080;">41</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">42</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">43</span> 
<span style="color: #008080;">44</span> 
<span style="color: #008080;">45</span>         <span style="color: #0000ff;">#region</span> 打开一个新的Session
<span style="color: #008080;">46</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> ISession OpenSession()
</span><span style="color: #008080;">47</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">48</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> _sessionFactory.OpenSession();
</span><span style="color: #008080;">49</span>
<span style="color: #008080;">50</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">51</span>         <span style="color: #0000ff;">#endregion</span>
<span style="color: #008080;">52</span> 
<span style="color: #008080;">53</span>     }</pre>
</div>
<p>与数据库的交互时，需要先在web.config配置（数据库为sql server）</p>
<div class="cnblogs_code">
<pre>&lt;configuration&gt;
  &lt;configSections&gt;
    &lt;section name=<span style="color: #800000;">"</span><span style="color: #800000;">hibernate-configuration</span><span style="color: #800000;">"</span> type=<span style="color: #800000;">"</span><span style="color: #800000;">NHibernate.Cfg.ConfigurationSectionHandler, NHibernate</span><span style="color: #800000;">"</span> /&gt;
  &lt;/configSections&gt;
  &lt;!--NHibernate配置开始--&gt;
  &lt;hibernate-configuration xmlns=<span style="color: #800000;">"</span><span style="color: #800000;">urn:nhibernate-configuration-2.2</span><span style="color: #800000;">"</span>&gt;
    &lt;session-factory&gt;
      &lt;property name=<span style="color: #800000;">"</span><span style="color: #800000;">connection.provider</span><span style="color: #800000;">"</span>&gt;NHibernate.Connection.DriverConnectionProvider&lt;/property&gt;
      &lt;property name=<span style="color: #800000;">"</span><span style="color: #800000;">connection.driver_class</span><span style="color: #800000;">"</span>&gt;NHibernate.Driver.SqlClientDriver&lt;/property&gt;
      &lt;property name=<span style="color: #800000;">"</span><span style="color: #800000;">dialect</span><span style="color: #800000;">"</span>&gt;NHibernate.Dialect.MsSql2012Dialect&lt;/property&gt;
      &lt;property name=<span style="color: #800000;">"</span><span style="color: #800000;">show_sql</span><span style="color: #800000;">"</span>&gt;<span style="color: #0000ff;">false</span>&lt;/property&gt;
      &lt;property name=<span style="color: #800000;">"</span><span style="color: #800000;">connection.connection_string_name</span><span style="color: #800000;">"</span>&gt;ylsdai&lt;/property&gt;
      &lt;property name=<span style="color: #800000;">"</span><span style="color: #800000;">adonet.batch_size</span><span style="color: #800000;">"</span>&gt;<span style="color: #800080;">30</span>&lt;/property&gt;
      &lt;property name=<span style="color: #800000;">"</span><span style="color: #800000;">generate_statistics</span><span style="color: #800000;">"</span>&gt;<span style="color: #0000ff;">false</span>&lt;/property&gt;
      &lt;property name=<span style="color: #800000;">"</span><span style="color: #800000;">format_sql</span><span style="color: #800000;">"</span>&gt;<span style="color: #0000ff;">true</span>&lt;/property&gt;
      &lt;property name=<span style="color: #800000;">"</span><span style="color: #800000;">command_timeout</span><span style="color: #800000;">"</span>&gt;<span style="color: #800080;">60</span>&lt;/property&gt;
      &lt;property name=<span style="color: #800000;">"</span><span style="color: #800000;">current_session_context_class</span><span style="color: #800000;">"</span>&gt;web&lt;/property&gt;
      &lt;!--&lt;property name=<span style="color: #800000;">"</span><span style="color: #800000;">cache.provider_class</span><span style="color: #800000;">"</span>&gt;NHibernate.Caches.SysCache2.SysCacheProvider,NHibernate.Caches.SysCache2&lt;/property&gt;
      &lt;property name=<span style="color: #800000;">"</span><span style="color: #800000;">cache.default_expiration</span><span style="color: #800000;">"</span>&gt;<span style="color: #800080;">120</span>&lt;/property&gt;
      &lt;property name=<span style="color: #800000;">"</span><span style="color: #800000;">cache.use_second_level_cache</span><span style="color: #800000;">"</span>&gt;<span style="color: #0000ff;">true</span>&lt;/property&gt;
      &lt;property name=<span style="color: #800000;">"</span><span style="color: #800000;">cache.use_query_cache</span><span style="color: #800000;">"</span>&gt;<span style="color: #0000ff;">true</span>&lt;/property&gt;--&gt;
    &lt;/session-factory&gt;
  &lt;/hibernate-configuration&gt;
  &lt;!--NHibernate配置结束--&gt;
  &lt;connectionStrings&gt;
    &lt;!--test_db--&gt;
    &lt;!--&lt;add name=<span style="color: #800000;">"</span><span style="color: #800000;">ylsdai</span><span style="color: #800000;">"</span> connectionString=<span style="color: #800000;">"</span><span style="color: #800000;">data source=0.0.0.1,111;database=test_db;uid=sa;pwd=123456</span><span style="color: #800000;">"</span> providerName=<span style="color: #800000;">"</span><span style="color: #800000;">System.Data.SqlClient</span><span style="color: #800000;">"</span> /&gt;
  &lt;/connectionStrings&gt;
&lt;/configuration&gt;</pre>
</div>
<p>映射类</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">using</span><span style="color: #000000;"> NHibernate.Mapping.ByCode;
</span><span style="color: #0000ff;">using</span><span style="color: #000000;"> NHibernate.Mapping.ByCode.Conformist;

</span><span style="color: #0000ff;">namespace</span><span style="color: #000000;"> ClassMapping
{
    </span><span style="color: #0000ff;">#region</span> CityMap
    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> CityMap : ClassMapping&lt;City&gt;<span style="color: #000000;">
    {
        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> CityMap()
        {
            
            SelectBeforeUpdate(</span><span style="color: #0000ff;">true</span><span style="color: #000000;">);
            DynamicUpdate(</span><span style="color: #0000ff;">true</span><span style="color: #000000;">);
            </span><span style="color: #008000;">//</span><span style="color: #008000;">Cache(p =&gt; p.Usage(CacheUsage.ReadWrite));</span>
            Id(p =&gt; p.CityId, map =&gt;<span style="color: #000000;"> map.Generator(Generators.Native));
            Property(p </span>=&gt;<span style="color: #000000;"> p.OldCityId);
            Property(p </span>=&gt;<span style="color: #000000;"> p.ParentId);
            Property(p </span>=&gt;<span style="color: #000000;"> p.CityName);
            Property(p </span>=&gt;<span style="color: #000000;"> p.EnCityName);
            Property(p </span>=&gt;<span style="color: #000000;"> p.CityImgUrl);
            Property(p </span>=&gt;<span style="color: #000000;"> p.LatLng);
            Property(p </span>=&gt;<span style="color: #000000;"> p.Keywords);
            Property(p </span>=&gt;<span style="color: #000000;"> p.IsRecommend);
            Property(p </span>=&gt;<span style="color: #000000;"> p.IsDepart);
            Property(p </span>=&gt;<span style="color: #000000;"> p.AreaId);
            Property(p </span>=&gt;<span style="color: #000000;"> p.CityContent);
        }
    }
    </span><span style="color: #0000ff;">#endregion</span><span style="color: #000000;">
}</span></pre>
</div>
<p>&nbsp;</p>
<p>将实体写好，就可以进行实现了</p>
<p>&nbsp;</p>
<p>但是在迁移到.net core的时候遇到的问题：</p>
<p>1. 创建Session，使用.net&nbsp;framework的方法将不可用</p>
<p>2.config中对于NHiberante的配置也读取不到</p>
<p>3.基于问题1，映射类也无法进行实现</p>
<p>好在是在.net core中有一个辅助的开源框架<a href="http://fluentnhibernate.org/">Fluent NHibernate</a>，它可以帮我解决上面遇到的问题，但是在具体使用时也踩了不少坑</p>
<p>1.网上的文档基本都是映射类在xml中的，但是当实际项目在.cs文件中时，大量的文件映射从.cs文件迁到到.xml文件将变得特别繁琐</p>
<p>最后的解决办法，创建session方法中GetSessionFactory方法做以下修改</p>
<div class="cnblogs_code">
<pre>        <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
        <span style="color: #808080;">///</span><span style="color: #008000;"> 创建ISessionFactory
        </span><span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
        <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;returns&gt;&lt;/returns&gt;</span>
        <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> ISessionFactory GetSessionFactory()
        {
            </span><span style="color: #0000ff;">var</span> assemblyName = Assembly.Load(<span style="color: #800000;">"</span><span style="color: #800000;">ClassMapping</span><span style="color: #800000;">"</span><span style="color: #000000;">);

            NHibernate.Cfg.Configuration setCfg(NHibernate.Cfg.Configuration c)
            {
                c.Properties.Add(</span><span style="color: #800000;">"</span><span style="color: #800000;">show_sql</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">true</span><span style="color: #800000;">"</span><span style="color: #000000;">);
                c.Properties.Add(</span><span style="color: #800000;">"</span><span style="color: #800000;">adonet.batch_size</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">1000</span><span style="color: #800000;">"</span><span style="color: #000000;">);
                c.Properties.Add(</span><span style="color: #800000;">"</span><span style="color: #800000;">generate_statistics</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">false</span><span style="color: #800000;">"</span><span style="color: #000000;">);
                c.Properties.Add(</span><span style="color: #800000;">"</span><span style="color: #800000;">format_sql</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">true</span><span style="color: #800000;">"</span><span style="color: #000000;">);
                c.Properties.Add(</span><span style="color: #800000;">"</span><span style="color: #800000;">command_timeout</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">60</span><span style="color: #800000;">"</span><span style="color: #000000;">);
                c.Properties.Add(</span><span style="color: #800000;">"</span><span style="color: #800000;">current_session_context_class</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">web</span><span style="color: #800000;">"</span><span style="color: #000000;">);
                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> c;
            }

            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> Fluently.Configure().Database(
FluentNHibernate.Cfg.Db.MsSqlConfiguration.MsSql2012.ConnectionString(</span><span style="color: #800000;">"</span><span style="color: #800000;">Server=0.0.0.1,111;Database=test_db;Uid=sa;Pwd=123456;</span><span style="color: #800000;">"</span><span style="color: #000000;">))
                        .Mappings(m </span>=&gt;<span style="color: #000000;"> m.FluentMappings.AddFromAssembly(assemblyName))
                        .ExposeConfiguration(c </span>=&gt; <span style="color: #0000ff;">new</span> SchemaUpdate(c).Execute(<span style="color: #0000ff;">true</span>, <span style="color: #0000ff;">false</span><span style="color: #000000;">))
                        .ExposeConfiguration(c </span>=&gt;<span style="color: #000000;"> setCfg(c))
                        </span><span style="color: #008000;">//</span><span style="color: #008000;">.ExposeConfiguration(f =&gt; f.SetInterceptor(new SqlStatementInterceptor()))</span>
<span style="color: #000000;">                        .BuildSessionFactory();

        }</span></pre>
</div>
<p>其中映射类的引入在</p>
<p>.Mappings(m =&gt; m.FluentMappings.AddFromAssembly(assemblyName))</p>
<p>这句话，是将命名空间引入，所以具体映射类可以重新新建一个项目，名字就叫做ClassMapping，具体的映射类做以下修改</p>
<div class="cnblogs_code">
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> Entity;
</span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">using</span><span style="color: #000000;"> FluentNHibernate.Mapping;
</span><span style="color: #008080;"> 3</span> 
<span style="color: #008080;"> 4</span> <span style="color: #0000ff;">namespace</span><span style="color: #000000;"> ClassMapping
</span><span style="color: #008080;"> 5</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 6</span>     <span style="color: #0000ff;">#region</span> CityMap
<span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> CityMap : ClassMap&lt;City&gt;
<span style="color: #008080;"> 8</span> <span style="color: #000000;">    {
</span><span style="color: #008080;"> 9</span>         <span style="color: #0000ff;">public</span><span style="color: #000000;"> CityMap()
</span><span style="color: #008080;">10</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">11</span>             Table(<span style="color: #800000;">"</span><span style="color: #800000;">City</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">12</span> 
<span style="color: #008080;">13</span>             <span style="color: #008000;">//</span><span style="color: #008000;">SelectBeforeUpdate(true);
</span><span style="color: #008080;">14</span>             <span style="color: #008000;">//</span><span style="color: #008000;">DynamicUpdate(true);
</span><span style="color: #008080;">15</span>             <span style="color: #008000;">//</span><span style="color: #008000;">Cache(p =&gt; p.Usage(CacheUsage.ReadWrite));</span>
<span style="color: #008080;">16</span>             Id(p =&gt;<span style="color: #000000;"> p.CityId);
</span><span style="color: #008080;">17</span>             Map(p =&gt;<span style="color: #000000;"> p.OldCityId);
</span><span style="color: #008080;">18</span>             Map(p =&gt;<span style="color: #000000;"> p.ParentId);
</span><span style="color: #008080;">19</span>             Map(p =&gt;<span style="color: #000000;"> p.CityName);
</span><span style="color: #008080;">20</span>             Map(p =&gt;<span style="color: #000000;"> p.EnCityName);
</span><span style="color: #008080;">21</span>             Map(p =&gt;<span style="color: #000000;"> p.CityImgUrl);
</span><span style="color: #008080;">22</span>             Map(p =&gt;<span style="color: #000000;"> p.LatLng);
</span><span style="color: #008080;">23</span>             Map(p =&gt;<span style="color: #000000;"> p.Keywords);
</span><span style="color: #008080;">24</span>             Map(p =&gt;<span style="color: #000000;"> p.IsRecommend);
</span><span style="color: #008080;">25</span>             Map(p =&gt;<span style="color: #000000;"> p.IsDepart);
</span><span style="color: #008080;">26</span>             Map(p =&gt;<span style="color: #000000;"> p.AreaId);
</span><span style="color: #008080;">27</span>             Map(p =&gt;<span style="color: #000000;"> p.CityContent);
</span><span style="color: #008080;">28</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">29</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">30</span>     <span style="color: #0000ff;">#endregion</span>
<span style="color: #008080;">31</span> 
<span style="color: #008080;">32</span> }</pre>
</div>
<p>&nbsp;</p>
<p>在迁移过程中会碰到映射关系的迁移</p>
<p>以前的版本中为</p>
<div class="cnblogs_code">
<pre>            OneToOne(p =&gt; p.City, map =&gt;<span style="color: #000000;">
            {
                map.Cascade(Cascade.All);
                map.Lazy(LazyRelation.Proxy);
            });</span><span style="color: #008000;">//</span><span style="color: #008000;">一对一</span>
<span style="color: #000000;">
            ManyToOne(p </span>=&gt; p.Province, map =&gt; map.Column(<span style="color: #800000;">"</span><span style="color: #800000;">ProvinceId</span><span style="color: #800000;">"</span>));<span style="color: #008000;">//</span><span style="color: #008000;">多对一</span>
<span style="color: #000000;">
            Bag(p </span>=&gt; p.Counties, map =&gt;<span style="color: #000000;">
            {
                map.Key(k </span>=&gt; k.Column(<span style="color: #800000;">"</span><span style="color: #800000;">CountyId</span><span style="color: #800000;">"</span><span style="color: #000000;">));
                map.OrderBy(k </span>=&gt;<span style="color: #000000;"> k.SortId);
            }, rel </span>=&gt; rel.OneToMany());<span style="color: #008000;">//</span><span style="color: #008000;">一对多</span></pre>
</div>
<p>.net core版本中对应为</p>
<div class="cnblogs_code">
<pre>HasOne(p =&gt; p.City).Cascade.All().LazyLoad();<span style="color: #008000;">//</span><span style="color: #008000;">一对一

</span><span style="color: #008000;">//</span><span style="color: #008000;">References&lt;Province&gt;(r =&gt; r.Province).Column("ProvinceId").ForeignKey("ProvinceId").Cascade.None();</span><span style="color: #008000;">//</span><span style="color: #008000;">多对一，在实际运用中会出现问题</span>
<span style="color: #000000;">
HasMany(p </span>=&gt; p.Counties).KeyColumn(<span style="color: #800000;">"</span><span style="color: #800000;">CountyId</span><span style="color: #800000;">"</span>).OrderBy(<span style="color: #800000;">"</span><span style="color: #800000;">CountyId</span><span style="color: #800000;">"</span>).LazyLoad();<span style="color: #008000;">//</span><span style="color: #008000;">一对多</span></pre>
</div>
<p>&nbsp;</p>
<p>city实体</p>
<div class="cnblogs_code">
<pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">    [Serializable]
</span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> City : BaseEntity
</span><span style="color: #008080;"> 3</span> <span style="color: #000000;">    {
</span><span style="color: #008080;"> 4</span>          <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;"> 5</span>          <span style="color: #808080;">///</span><span style="color: #008000;"> CityId
</span><span style="color: #008080;"> 6</span>          <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;"> 7</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">virtual</span> <span style="color: #0000ff;">int</span> CityId { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; }
</span><span style="color: #008080;"> 8</span> 
<span style="color: #008080;"> 9</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">10</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> Version
</span><span style="color: #008080;">11</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">12</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">virtual</span> <span style="color: #0000ff;">int</span> Version { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; }
</span><span style="color: #008080;">13</span> 
<span style="color: #008080;">14</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">15</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> OldCityId
</span><span style="color: #008080;">16</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">17</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">virtual</span> <span style="color: #0000ff;">int</span> OldCityId { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; } 
</span><span style="color: #008080;">18</span> 
<span style="color: #008080;">19</span>          <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">20</span>          <span style="color: #808080;">///</span><span style="color: #008000;"> ParentId
</span><span style="color: #008080;">21</span>          <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">22</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">virtual</span> <span style="color: #0000ff;">int</span> ParentId { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; } 
</span><span style="color: #008080;">23</span> 
<span style="color: #008080;">24</span>          <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">25</span>          <span style="color: #808080;">///</span><span style="color: #008000;"> 城市名称
</span><span style="color: #008080;">26</span>          <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">27</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">virtual</span> <span style="color: #0000ff;">string</span> CityName { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; } 
</span><span style="color: #008080;">28</span> 
<span style="color: #008080;">29</span>          <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">30</span>          <span style="color: #808080;">///</span><span style="color: #008000;"> 城市英文名称
</span><span style="color: #008080;">31</span>          <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">32</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">virtual</span> <span style="color: #0000ff;">string</span> EnCityName { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; } 
</span><span style="color: #008080;">33</span> 
<span style="color: #008080;">34</span>          <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">35</span>          <span style="color: #808080;">///</span><span style="color: #008000;"> CityImgUrl
</span><span style="color: #008080;">36</span>          <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">37</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">virtual</span> <span style="color: #0000ff;">string</span> CityImgUrl { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; } 
</span><span style="color: #008080;">38</span> 
<span style="color: #008080;">39</span>          <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">40</span>          <span style="color: #808080;">///</span><span style="color: #008000;"> 经纬度
</span><span style="color: #008080;">41</span>          <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">42</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">virtual</span> <span style="color: #0000ff;">string</span> LatLng { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; } 
</span><span style="color: #008080;">43</span> 
<span style="color: #008080;">44</span>          <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">45</span>          <span style="color: #808080;">///</span><span style="color: #008000;"> 关键字
</span><span style="color: #008080;">46</span>          <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">47</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">virtual</span> <span style="color: #0000ff;">string</span> Keywords { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; }
</span><span style="color: #008080;">48</span> 
<span style="color: #008080;">49</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">50</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 是否推荐
</span><span style="color: #008080;">51</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">52</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">virtual</span> <span style="color: #0000ff;">bool</span> IsRecommend { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; }
</span><span style="color: #008080;">53</span> 
<span style="color: #008080;">54</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">55</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> IsDepart
</span><span style="color: #008080;">56</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">57</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">virtual</span> <span style="color: #0000ff;">bool</span> IsDepart { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; } 
</span><span style="color: #008080;">58</span> 
<span style="color: #008080;">59</span>          <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">60</span>          <span style="color: #808080;">///</span><span style="color: #008000;"> 航区
</span><span style="color: #008080;">61</span>          <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">62</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">virtual</span> <span style="color: #0000ff;">int</span> AreaId { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; } 
</span><span style="color: #008080;">63</span> 
<span style="color: #008080;">64</span>          <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">65</span>          <span style="color: #808080;">///</span><span style="color: #008000;"> 城市介绍
</span><span style="color: #008080;">66</span>          <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">67</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">virtual</span> <span style="color: #0000ff;">string</span> CityContent { <span style="color: #0000ff;">get</span>; <span style="color: #0000ff;">set</span><span style="color: #000000;">; } 
</span><span style="color: #008080;">68</span> 
<span style="color: #008080;">69</span>     }</pre>
</div>
<p>&nbsp;</p>
<p>下面是操作session，进行数据库调用的方法</p>
<div class="cnblogs_code">
<pre><span style="color: #008080;">  1</span>     <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">  2</span>     <span style="color: #808080;">///</span><span style="color: #008000;"> Hibernate操作Helper 
</span><span style="color: #008080;">  3</span>     <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">  4</span>     <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;typeparam name="T"&gt;&lt;/typeparam&gt;</span>
<span style="color: #008080;">  5</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> DbHelper&lt;T&gt; <span style="color: #0000ff;">where</span><span style="color: #000000;"> T : BaseEntity
</span><span style="color: #008080;">  6</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">  7</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">readonly</span> ISession _session =<span style="color: #000000;"> SessionBuilder.GetSession();
</span><span style="color: #008080;">  8</span>         <span style="color: #008000;">//</span><span style="color: #008000;">protected static readonly ILog Log = LogManager.GetLogger(MethodBase.GetCurrentMethod().DeclaringType);</span>
<span style="color: #008080;">  9</span> 
<span style="color: #008080;"> 10</span>         <span style="color: #0000ff;">public</span><span style="color: #000000;"> DbHelper() { }
</span><span style="color: #008080;"> 11</span> 
<span style="color: #008080;"> 12</span>         <span style="color: #0000ff;">public</span><span style="color: #000000;"> DbHelper(ISession session)
</span><span style="color: #008080;"> 13</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 14</span>             _session =<span style="color: #000000;"> session;
</span><span style="color: #008080;"> 15</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 16</span> 
<span style="color: #008080;"> 17</span>         <span style="color: #0000ff;">#region</span> 获取一个实体
<span style="color: #008080;"> 18</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;"> 19</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 获取一个实体（一级缓存）
</span><span style="color: #008080;"> 20</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;"> 21</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;param name="id"&gt;&lt;/param&gt;</span>
<span style="color: #008080;"> 22</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: #008080;"> 23</span>         <span style="color: #0000ff;">public</span> T Load(<span style="color: #0000ff;">int</span><span style="color: #000000;"> id)
</span><span style="color: #008080;"> 24</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 25</span>             <span style="color: #0000ff;">return</span> _session.Load&lt;T&gt;<span style="color: #000000;">(id);
</span><span style="color: #008080;"> 26</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 27</span> 
<span style="color: #008080;"> 28</span>         <span style="color: #0000ff;">#endregion</span>
<span style="color: #008080;"> 29</span> 
<span style="color: #008080;"> 30</span>         <span style="color: #0000ff;">#region</span> 获取一个实体（缓存）
<span style="color: #008080;"> 31</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;"> 32</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 获取一个实体（二级缓存）
</span><span style="color: #008080;"> 33</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;"> 34</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;param name="id"&gt;&lt;/param&gt;</span>
<span style="color: #008080;"> 35</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: #008080;"> 36</span>         <span style="color: #0000ff;">public</span> T Get(<span style="color: #0000ff;">int</span><span style="color: #000000;"> id)
</span><span style="color: #008080;"> 37</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 38</span>             <span style="color: #0000ff;">return</span> _session.Get&lt;T&gt;<span style="color: #000000;">(id);
</span><span style="color: #008080;"> 39</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 40</span>         <span style="color: #0000ff;">#endregion</span>
<span style="color: #008080;"> 41</span> 
<span style="color: #008080;"> 42</span>         <span style="color: #0000ff;">#region</span> 销毁一个实体
<span style="color: #008080;"> 43</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;"> 44</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 销毁一个实体
</span><span style="color: #008080;"> 45</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;"> 46</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;param name="obj"&gt;&lt;/param&gt;</span>
<span style="color: #008080;"> 47</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: #008080;"> 48</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> Evict(<span style="color: #0000ff;">object</span><span style="color: #000000;"> obj)
</span><span style="color: #008080;"> 49</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 50</span> <span style="color: #000000;">            _session.Evict(obj);
</span><span style="color: #008080;"> 51</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 52</span>         <span style="color: #0000ff;">#endregion</span>
<span style="color: #008080;"> 53</span> 
<span style="color: #008080;"> 54</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;"> 55</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 根据SQL语句获取
</span><span style="color: #008080;"> 56</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;"> 57</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;param name="sql"&gt;&lt;/param&gt;</span>
<span style="color: #008080;"> 58</span>         <span style="color: #0000ff;">public</span> ISQLQuery CreateSqlQuery(<span style="color: #0000ff;">string</span><span style="color: #000000;"> sql)
</span><span style="color: #008080;"> 59</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 60</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> _session.CreateSQLQuery(sql);
</span><span style="color: #008080;"> 61</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 62</span> 
<span style="color: #008080;"> 63</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;"> 64</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 获取集合
</span><span style="color: #008080;"> 65</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;"> 66</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;param name="hql"&gt;&lt;/param&gt;</span>
<span style="color: #008080;"> 67</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: #008080;"> 68</span>         <span style="color: #0000ff;">public</span> ICriteria GetCriteria(<span style="color: #0000ff;">string</span><span style="color: #000000;"> hql)
</span><span style="color: #008080;"> 69</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 70</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> _session.CreateCriteria(hql);
</span><span style="color: #008080;"> 71</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 72</span> 
<span style="color: #008080;"> 73</span>         <span style="color: #0000ff;">#region</span> 获取全部数据
<span style="color: #008080;"> 74</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;"> 75</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 获取全部数据
</span><span style="color: #008080;"> 76</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;"> 77</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;param name="cacheable"&gt;</span><span style="color: #008000;">是否缓存</span><span style="color: #808080;">&lt;/param&gt;</span>
<span style="color: #008080;"> 78</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: #008080;"> 79</span>         <span style="color: #0000ff;">public</span> IEnumerable&lt;T&gt; GetAll(<span style="color: #0000ff;">bool</span><span style="color: #000000;"> cacheable)
</span><span style="color: #008080;"> 80</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 81</span>             <span style="color: #0000ff;">var</span> ic = _session.CreateCriteria(<span style="color: #0000ff;">typeof</span><span style="color: #000000;">(T));
</span><span style="color: #008080;"> 82</span>             IEnumerable&lt;T&gt; list = ic.SetCacheable(cacheable).List&lt;T&gt;() ?? <span style="color: #0000ff;">new</span> List&lt;T&gt;<span style="color: #000000;">();
</span><span style="color: #008080;"> 83</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> list;
</span><span style="color: #008080;"> 84</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 85</span>         <span style="color: #0000ff;">#endregion</span>
<span style="color: #008080;"> 86</span> 
<span style="color: #008080;"> 87</span>         <span style="color: #0000ff;">#region</span> 插入或者更新数据
<span style="color: #008080;"> 88</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;"> 89</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 插入数据
</span><span style="color: #008080;"> 90</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;"> 91</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;param name="entity"&gt;&lt;/param&gt;</span>
<span style="color: #008080;"> 92</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: #008080;"> 93</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> Save(T entity)
</span><span style="color: #008080;"> 94</span> <span style="color: #000000;">        {
</span><span style="color: #008080;"> 95</span>             <span style="color: #0000ff;">var</span> id = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 96</span>             <span style="color: #0000ff;">var</span> session = <span style="color: #0000ff;">this</span><span style="color: #000000;">._session;
</span><span style="color: #008080;"> 97</span>             ITransaction tan =<span style="color: #000000;"> session.BeginTransaction();
</span><span style="color: #008080;"> 98</span> 
<span style="color: #008080;"> 99</span>             <span style="color: #0000ff;">try</span>
<span style="color: #008080;">100</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">101</span>                 entity =<span style="color: #000000;"> session.Merge(entity);
</span><span style="color: #008080;">102</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">103</span>             <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e)
</span><span style="color: #008080;">104</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">105</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">Log.DebugFormat($"Save124，Exception：{e.Message}，entity:{JsonConvert.SerializeObject(entity)}");</span>
<span style="color: #008080;">106</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">107</span> 
<span style="color: #008080;">108</span>             <span style="color: #0000ff;">try</span>
<span style="color: #008080;">109</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">110</span> <span style="color: #000000;">                tan.Begin();
</span><span style="color: #008080;">111</span>                 id = (<span style="color: #0000ff;">int</span><span style="color: #000000;">)session.Save(entity);
</span><span style="color: #008080;">112</span> <span style="color: #000000;">                session.Flush();
</span><span style="color: #008080;">113</span> <span style="color: #000000;">                tan.Commit();
</span><span style="color: #008080;">114</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">115</span>             <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e)
</span><span style="color: #008080;">116</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">117</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">Log.DebugFormat($"Save136，Exception：{e.Message}，entity:{JsonConvert.SerializeObject(entity)}");</span>
<span style="color: #008080;">118</span> <span style="color: #000000;">                tan.Rollback();
</span><span style="color: #008080;">119</span>                 <span style="color: #0000ff;">throw</span><span style="color: #000000;">;
</span><span style="color: #008080;">120</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">121</span> 
<span style="color: #008080;">122</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> id;
</span><span style="color: #008080;">123</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">124</span>         <span style="color: #0000ff;">#endregion</span>
<span style="color: #008080;">125</span> 
<span style="color: #008080;">126</span>         <span style="color: #0000ff;">#region</span> 更新数据
<span style="color: #008080;">127</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">128</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 更新数据
</span><span style="color: #008080;">129</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">130</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;param name="entity"&gt;&lt;/param&gt;</span>
<span style="color: #008080;">131</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: #008080;">132</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> Update(T entity)
</span><span style="color: #008080;">133</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">134</span>             <span style="color: #0000ff;">int</span> result = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">135</span>             ITransaction tan =<span style="color: #000000;"> _session.BeginTransaction();
</span><span style="color: #008080;">136</span>             <span style="color: #0000ff;">var</span> session = <span style="color: #0000ff;">this</span><span style="color: #000000;">._session;
</span><span style="color: #008080;">137</span>             <span style="color: #008000;">//</span><span style="color: #008000;">entity = (T)_session.Merge(entity);</span>
<span style="color: #008080;">138</span>             <span style="color: #0000ff;">try</span>
<span style="color: #008080;">139</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">140</span>                 entity =<span style="color: #000000;"> session.Merge(entity);
</span><span style="color: #008080;">141</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">142</span>             <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e)
</span><span style="color: #008080;">143</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">144</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">Log.DebugFormat($"Update163，Exception：{e.Message}，entity:{JsonConvert.SerializeObject(entity)}");</span>
<span style="color: #008080;">145</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">146</span>             <span style="color: #0000ff;">try</span>
<span style="color: #008080;">147</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">148</span> <span style="color: #000000;">                tan.Begin();
</span><span style="color: #008080;">149</span> <span style="color: #000000;">                _session.Update(entity);
</span><span style="color: #008080;">150</span> <span style="color: #000000;">                _session.Flush();
</span><span style="color: #008080;">151</span> <span style="color: #000000;">                tan.Commit();
</span><span style="color: #008080;">152</span>                 result++<span style="color: #000000;">;
</span><span style="color: #008080;">153</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">154</span>             <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e)
</span><span style="color: #008080;">155</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">156</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">Log.DebugFormat($"Update175，Exception：{e.Message}，entity:{JsonConvert.SerializeObject(entity)}");</span>
<span style="color: #008080;">157</span> <span style="color: #000000;">                tan.Rollback();
</span><span style="color: #008080;">158</span>                 <span style="color: #0000ff;">throw</span><span style="color: #000000;">;
</span><span style="color: #008080;">159</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">160</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> result;
</span><span style="color: #008080;">161</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">162</span>         <span style="color: #0000ff;">#endregion</span>
<span style="color: #008080;">163</span> 
<span style="color: #008080;">164</span>         <span style="color: #0000ff;">#region</span> 删除一条数据
<span style="color: #008080;">165</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">166</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 删除一条数据
</span><span style="color: #008080;">167</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">168</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;param name="id"&gt;&lt;/param&gt;</span>
<span style="color: #008080;">169</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: #008080;">170</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> DeleteModelById(<span style="color: #0000ff;">int</span><span style="color: #000000;"> id)
</span><span style="color: #008080;">171</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">172</span>             <span style="color: #0000ff;">int</span> result = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">173</span>             <span style="color: #0000ff;">object</span> item =<span style="color: #000000;"> Get(id);
</span><span style="color: #008080;">174</span>             <span style="color: #008000;">//</span><span style="color: #008000;">ITransaction tan = _session.BeginTransaction();</span>
<span style="color: #008080;">175</span>             <span style="color: #0000ff;">try</span>
<span style="color: #008080;">176</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">177</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">tan.Begin();</span>
<span style="color: #008080;">178</span> <span style="color: #000000;">                _session.Delete(item);
</span><span style="color: #008080;">179</span> <span style="color: #000000;">                _session.Flush();
</span><span style="color: #008080;">180</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">tan.Commit();</span>
<span style="color: #008080;">181</span>                 result++<span style="color: #000000;">;
</span><span style="color: #008080;">182</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">183</span>             <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception)
</span><span style="color: #008080;">184</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">185</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">tan.Rollback();</span>
<span style="color: #008080;">186</span>                 <span style="color: #0000ff;">throw</span><span style="color: #000000;">;
</span><span style="color: #008080;">187</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">188</span> 
<span style="color: #008080;">189</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> result;
</span><span style="color: #008080;">190</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">191</span>         <span style="color: #0000ff;">#endregion</span>
<span style="color: #008080;">192</span> 
<span style="color: #008080;">193</span>         <span style="color: #0000ff;">#region</span> 删除一个实体对象
<span style="color: #008080;">194</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">195</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 删除一个实体对象
</span><span style="color: #008080;">196</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">197</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;param name="entity"&gt;&lt;/param&gt;</span>
<span style="color: #008080;">198</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: #008080;">199</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> DeleteModel(BaseEntity entity)
</span><span style="color: #008080;">200</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">201</span>             <span style="color: #0000ff;">var</span> result = <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">202</span>             <span style="color: #008000;">//</span><span style="color: #008000;">ITransaction tan = _session.BeginTransaction();</span>
<span style="color: #008080;">203</span>             <span style="color: #0000ff;">try</span>
<span style="color: #008080;">204</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">205</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">tan.Begin();</span>
<span style="color: #008080;">206</span> <span style="color: #000000;">                _session.Delete(entity);
</span><span style="color: #008080;">207</span> <span style="color: #000000;">                _session.Flush();
</span><span style="color: #008080;">208</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">tan.Commit();</span>
<span style="color: #008080;">209</span>                 result++<span style="color: #000000;">;
</span><span style="color: #008080;">210</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">211</span>             <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception)
</span><span style="color: #008080;">212</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">213</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">tan.Rollback();</span>
<span style="color: #008080;">214</span>                 <span style="color: #0000ff;">throw</span><span style="color: #000000;">;
</span><span style="color: #008080;">215</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">216</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> result;
</span><span style="color: #008080;">217</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">218</span>         <span style="color: #0000ff;">#endregion</span>
<span style="color: #008080;">219</span> 
<span style="color: #008080;">220</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">221</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 根据SQL语句删除
</span><span style="color: #008080;">222</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">223</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;param name="sql"&gt;&lt;/param&gt;</span>
<span style="color: #008080;">224</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> DeleteList(<span style="color: #0000ff;">string</span><span style="color: #000000;"> sql)
</span><span style="color: #008080;">225</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">226</span> <span style="color: #000000;">            _session.CreateSQLQuery(sql).UniqueResult();
</span><span style="color: #008080;">227</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">228</span> 
<span style="color: #008080;">229</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">230</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 删除泛型集合
</span><span style="color: #008080;">231</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">232</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;param name="models"&gt;&lt;/param&gt;</span>
<span style="color: #008080;">233</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> DeleteList(IList&lt;T&gt;<span style="color: #000000;"> models)
</span><span style="color: #008080;">234</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">235</span>             <span style="color: #0000ff;">foreach</span> (<span style="color: #0000ff;">var</span> model <span style="color: #0000ff;">in</span><span style="color: #000000;"> models)
</span><span style="color: #008080;">236</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">237</span> <span style="color: #000000;">                DeleteModel(model);
</span><span style="color: #008080;">238</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">239</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">240</span> 
<span style="color: #008080;">241</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">bool</span> IsExist(Expression&lt;Func&lt;T, <span style="color: #0000ff;">bool</span>&gt;&gt;<span style="color: #000000;"> keyWhere)
</span><span style="color: #008080;">242</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">243</span>             <span style="color: #0000ff;">var</span> ss = _session.QueryOver&lt;T&gt;<span style="color: #000000;">().Where(keyWhere);
</span><span style="color: #008080;">244</span>             <span style="color: #0000ff;">return</span> ss.RowCount() &gt; <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">245</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">246</span> 
<span style="color: #008080;">247</span>         <span style="color: #0000ff;">#region</span> GetQuery
<span style="color: #008080;">248</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">249</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> GetQuery
</span><span style="color: #008080;">250</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">251</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: #008080;">252</span>         <span style="color: #0000ff;">public</span> IQueryable&lt;T&gt;<span style="color: #000000;"> GetQuery()
</span><span style="color: #008080;">253</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">254</span>             <span style="color: #0000ff;">try</span>
<span style="color: #008080;">255</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">256</span>                 <span style="color: #0000ff;">return</span> _session.Query&lt;T&gt;<span style="color: #000000;">();
</span><span style="color: #008080;">257</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">258</span>             <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e)
</span><span style="color: #008080;">259</span> <span style="color: #000000;">            {
</span><span style="color: #008080;">260</span>                 <span style="color: #0000ff;">var</span> session =<span style="color: #000000;"> SessionBuilder.GetSession();
</span><span style="color: #008080;">261</span>                 <span style="color: #0000ff;">return</span> session.Query&lt;T&gt;<span style="color: #000000;">();
</span><span style="color: #008080;">262</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">263</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">264</span>         <span style="color: #0000ff;">#endregion</span>
<span style="color: #008080;">265</span> 
<span style="color: #008080;">266</span>         <span style="color: #0000ff;">#region</span> GetQueryOver
<span style="color: #008080;">267</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">268</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> GetQueryOver
</span><span style="color: #008080;">269</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">270</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: #008080;">271</span>         <span style="color: #0000ff;">public</span> IQueryOver&lt;T, T&gt; GetQueryOver(Expression&lt;Func&lt;T, <span style="color: #0000ff;">bool</span>&gt;&gt;<span style="color: #000000;"> keyWhere)
</span><span style="color: #008080;">272</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">273</span>             <span style="color: #0000ff;">return</span> _session.QueryOver&lt;T&gt;<span style="color: #000000;">().Where(keyWhere);
</span><span style="color: #008080;">274</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">275</span> 
<span style="color: #008080;">276</span>         <span style="color: #0000ff;">#endregion</span>
<span style="color: #008080;">277</span> 
<span style="color: #008080;">278</span>         <span style="color: #0000ff;">#region</span> GetQueryOver
<span style="color: #008080;">279</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">280</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> GetQueryOver
</span><span style="color: #008080;">281</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">282</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: #008080;">283</span>         <span style="color: #0000ff;">public</span> IQueryOver&lt;T, T&gt;<span style="color: #000000;"> GetQueryOver()
</span><span style="color: #008080;">284</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">285</span>             <span style="color: #0000ff;">return</span> _session.QueryOver&lt;T&gt;<span style="color: #000000;">();
</span><span style="color: #008080;">286</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">287</span>         <span style="color: #0000ff;">#endregion</span>
<span style="color: #008080;">288</span> 
<span style="color: #008080;">289</span>         <span style="color: #0000ff;">#region</span> 获取集合ByHql
<span style="color: #008080;">290</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">291</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 获取集合ByHql
</span><span style="color: #008080;">292</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">293</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;param name="strHql"&gt;&lt;/param&gt;</span>
<span style="color: #008080;">294</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: #008080;">295</span>         <span style="color: #0000ff;">public</span> IQuery GetQueryByHql(<span style="color: #0000ff;">string</span><span style="color: #000000;"> strHql)
</span><span style="color: #008080;">296</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">297</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> _session.CreateQuery(strHql);
</span><span style="color: #008080;">298</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">299</span>         <span style="color: #0000ff;">#endregion</span>
<span style="color: #008080;">300</span> 
<span style="color: #008080;">301</span>         <span style="color: #0000ff;">#region</span> 获取集合BySql
<span style="color: #008080;">302</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;summary&gt;</span>
<span style="color: #008080;">303</span>         <span style="color: #808080;">///</span><span style="color: #008000;"> 获取集合BySql
</span><span style="color: #008080;">304</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;/summary&gt;</span>
<span style="color: #008080;">305</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;param name="strSql"&gt;&lt;/param&gt;</span>
<span style="color: #008080;">306</span>         <span style="color: #808080;">///</span> <span style="color: #808080;">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: #008080;">307</span>         <span style="color: #0000ff;">public</span> IQuery GetQueryBySql(<span style="color: #0000ff;">string</span><span style="color: #000000;"> strSql)
</span><span style="color: #008080;">308</span> <span style="color: #000000;">        {
</span><span style="color: #008080;">309</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> _session.CreateSQLQuery(strSql);
</span><span style="color: #008080;">310</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">311</span>         <span style="color: #0000ff;">#endregion</span>
<span style="color: #008080;">312</span>     }</pre>
</div>
<p>&nbsp;</p>